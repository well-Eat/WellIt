<html layout:decorate="~{layout}">

<head>
	<link rel="stylesheet" href="/css/wellit.css">
	<!-- font font-awesome CDN -->
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
		integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
		crossorigin="anonymous" referrerpolicy="no-referrer" />
	<style>
		.recipe-image {
			width: 100%;
			height: 300px;
			object-fit: cover;
			border-radius: 10px;
		}

		.ingredient-list {
			background-color: #f8f9fa;
			border-radius: 5px;
			padding: 15px;
			margin-bottom: 20px;
		}

		.step {
			margin-bottom: 20px;
		}



		.card:hover {
			transform: scale(1);
			/* í˜¸ë²„ ì‹œ í™•ëŒ€ íš¨ê³¼ */
		}
	</style>
</head>

<body>
	<div layout:fragment="content" class="content">
		<div class="container my-4">
			<!-- í˜ì´ì§€ ì œëª© -->
			<div class="row mt-5">
				<div class="col text-center">
					<h1 class='fw-bold fs-1' th:text="${recipe.recpName}"></h1>
				</div>
			</div>

			<!-- ìš”ë¦¬ ì •ë³´ ìš”ì•½ -->
			<section class="recipe-info mb-4 py-4 rounded-2">
				<div class="card">
					<div class="row no-gutters">
						<div class="col-md-4 p-4">
							<div id="recipeCarousel" class="carousel slide" data-bs-ride="carousel"
								th:if="${recipe.recpmainImgList.size() > 0}">
								<div class="carousel-inner">
									<th:block th:each="img, iterStat : ${recipe.recpmainImgList}">
										<div class="carousel-item"
											th:class="${iterStat.index == 0} ? 'active carousel-item' : 'carousel-item'">
											<img th:src="${img.imgSrc}" alt="ë©”ì¸ ì´ë¯¸ì§€" class="recipe-image" />
										</div>
									</th:block>
								</div>
								<button class="carousel-control-prev" type="button" data-bs-target="#recipeCarousel"
									data-bs-slide="prev">
									<span class="carousel-control-prev-icon" aria-hidden="true"></span>
									<span class="visually-hidden">ì´ì „</span>
								</button>
								<button class="carousel-control-next" type="button" data-bs-target="#recipeCarousel"
									data-bs-slide="next">
									<span class="carousel-control-next-icon" aria-hidden="true"></span>
									<span class="visually-hidden">ë‹¤ìŒ</span>
								</button>
							</div>
							<p th:if="${recipe.recpmainImgList.size() == 0}">ë©”ì¸ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
						</div>

						<div class="col-md-8">
							<div class="card-body">
								<h5 class="fw-bolder">ìš”ë¦¬ ê°„ë‹¨ ì†Œê°œ
									<span class="favorite-btn btn hm-btn-green float-end"
										th:data-userid="${session.UserId}" th:data-recipeid="${recipe.id}">
										<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
											th:attr="fill=${isFavorite} ? 'red' : 'currentColor'" class="bi"
											th:classappend="${isFavorite} ? 'bi-heart-fill' : 'bi-heart'"
											viewBox="0 0 16 16">
											<path th:if="${isFavorite}" fill-rule="evenodd"
												d="M8 1.314C12.438-3.248 23.534 4.735 8 15-7.534 4.736 3.562-3.248 8 1.314" />
											<path th:if="${!isFavorite}"
												d="m8 2.748-.717-.737C5.6.281 2.514.878 1.4 3.053c-.523 1.023-.641 2.5.314 4.385.92 1.815 2.834 3.989 6.286 6.357 3.452-2.368 5.365-4.542 6.286-6.357.955-1.886.838-3.362.314-4.385C13.486.878 10.4.28 8.717 2.01zM8 15C-7.333 4.868 3.279-3.04 7.824 1.143q.09.083.176.171a3 3 0 0 1 .176-.17C12.72-3.042 23.333 4.867 8 15" />
										</svg>
									</span>
									<input type="hidden" id="userId" th:value="${session.UserId}" />
									<input type="hidden" id="recipeId" th:value="${recipe.id}" />
								</h5>
								<p th:text="${recipe.recpIntroduce}" class="lead"></p>
								<p><strong>ì‘ì„±ì:</strong> <span th:text="${recipe.writer}"></span></p>
								<p>
									<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="black"
										class="bi bi-people-fill" viewBox="0 0 16 16">
										<path
											d="M7 14s-1 0-1-1 1-4 5-4 5 3 5 4-1 1-1 1zm4-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6m-5.784 6A2.24 2.24 0 0 1 5 13c0-1.355.68-2.75 1.936-3.72A6.3 6.3 0 0 0 5 9c-4 0-5 3-5 4s1 1 1 1zM4.5 8a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5" />
									</svg>
									<span th:text="${recipe.servings}"></span>ì¸ë¶„
								</p>
								<p>
									<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="black"
										class="bi bi-alarm" viewBox="0 0 16 16">
										<path
											d="M8.5 5.5a.5.5 0 0 0-1 0v3.362l-1.429 2.38a.5.5 0 1 0 .858.515l1.5-2.5A.5.5 0 0 0 8.5 9z" />
										<path
											d="M6.5 0a.5.5 0 0 0 0 1H7v1.07a7.001 7.001 0 0 0-3.273 12.474l-.602.602a.5.5 0 0 0 .707.708l.746-.746A6.97 6.97 0 0 0 8 16a6.97 6.97 0 0 0 3.422-.892l.746.746a.5.5 0 0 0 .707-.708l-.601-.602A7.001 7.001 0 0 0 9 2.07V1h.5a.5.5 0 0 0 0-1zm1.038 3.018a6 6 0 0 1 .924 0 6 6 0 1 1-.924 0M0 3.5c0 .753.333 1.429.86 1.887A8.04 8.04 0 0 1 4.387 1.86 2.5 2.5 0 0 0 0 3.5M13.5 1c-.753 0-1.429.333-1.887.86a8.04 8.04 0 0 1 3.527 3.527A2.5 2.5 0 0 0 13.5 1" />
									</svg>
									<span th:text="${recipe.cookTime} + ' ë¶„'"></span>
								</p>
								<p><strong>ë‚œì´ë„:</strong>
									<span th:if="${recipe.difficulty == 'diff_easy'}" th:text="'ì‰¬ì›€'"></span>
									<span th:if="${recipe.difficulty == 'diff_normal'}" th:text="'ë³´í†µ'"></span>
									<span th:if="${recipe.difficulty == 'diff_hard'}" th:text="'ì–´ë ¤ì›€'"></span>
								</p>
								<p><strong>íƒœê·¸:</strong> <span th:text="${recipe.recpTags}"></span></p>

							</div>
						</div>
					</div>
				</div>
			</section>

			<!-- ì¬ë£Œ ëª©ë¡ -->
			<h2 class="mt-4">ì¬ë£Œ</h2>
			<div class="ingredient-list">
				<table class="table">
					<thead>
						<tr>
							<th>ì¬ë£Œ ì´ë¦„</th>
							<th>ìˆ˜ëŸ‰</th>
						</tr>
					</thead>
					<tbody>
						<th:block th:each="ingredient : ${recipe.recpIngredientList}">
							<tr>
								<td th:text="${ingredient.ingredientName}"></td>
								<td th:text="${ingredient.amount}"></td>
							</tr>
						</th:block>
					</tbody>
				</table>
			</div>

			<!-- ì¶”ì²œ ì œí’ˆ ëª©ë¡ -->
			<h2 class="mt-4">ì´ëŸ° ì¬ë£Œë“¤ì€ ì–´ë•Œìš”? ğŸ¥— </h2>
			<div class="product-container">
				<div class="row" id="productRow">
					<th:block th:each="ingredient : ${recipe.recpIngredientList}">
						<th:block th:each="product : ${productList}">
							<th:block th:if="${#lists.contains(product.prodName, ingredient.ingredientName)}">
								<div class="col-md-3 mb-3 product-card"> <!-- 4ê°œì”© ë°°ì¹˜í•˜ê¸° ìœ„í•´ col-md-3 ì‚¬ìš© -->
									<div class="card">
										<div class="card-body">
											<!-- ìƒí’ˆì´ë¯¸ì§€ -->
											<div class="card-img-wrapper rounded-2 mb-3">
												<a th:href="@{|/shop/detail/${product.prodId}|}" class="d-block">
													<div class="card-img-box">
														<img th:src="${product.prodMainImg}" alt="" class="img-fluid" />
													</div>
												</a>
											</div>

											<!-- ë‹´ê¸°ë²„íŠ¼ -->
											<a href="javascript:void(0);" class="addCartBtn btn btn-outline-secondary w-100"
												th:onclick="addToCart([[${product.prodId}]], 1);"><i
													class="fa-solid fa-cart-shopping" style="color: #666;"></i> ë‹´ê¸°</a>

											<div class="card-body">
												<a th:href="@{|/shop/detail/${product.prodId}|}" class="d-block">
													<h5 class="prodName card-title c333" th:text="${product.prodName}">
													</h5>
													<p class="prodDesc card-text" th:text="${product.prodDesc}"></p>

													<!--í• ì¸ìœ¨ ìˆëŠ” ê²½ìš° ê°€ê²© í‘œì‹œ -->
													<th:block
														th:if="${product.prodDiscount != null and product.prodDiscount > 0}">
														<p class="prodOrgPrice card-text"
															th:text="|${#numbers.formatInteger(product.prodOrgPrice,3,'COMMA')}ì›|">
														</p>
														<p class="prodDiscount card-text mr-4"
															th:text="${#numbers.formatPercent(product.prodDiscount,2,0)}">
														</p>
														<p class="prodFinalPrice card-text c333"
															th:text="|${#numbers.formatInteger(product.prodOrgPrice - product.prodOrgPrice * product.prodDiscount ,3,'COMMA') }ì›|">
														</p>
													</th:block>

													<!--í• ì¸ìœ¨ ì—†ëŠ” ê²½ìš° ê°€ê²© í‘œì‹œ-->
													<p class="prodFinalPrice card-text c333"
														th:if="${product.prodDiscount == null or product.prodDiscount == 0}"
														th:text="|${#numbers.formatInteger(product.prodOrgPrice,3,'COMMA')}ì›|">
													</p>

													<!--ìƒí’ˆ ì¹´ìš´íŠ¸ ë·° ë¼ì¸-->
													<div class="prodCount card-text d-flex ">
														<!--ì¡°íšŒìˆ˜-->
														<p class="prodView d-inline-block me-2">
															<i class="fa-regular fa-eye"></i>
															<span th:text="${product.viewCnt}"></span>
														</p>

														<!--ë¦¬ë·°ìˆ˜-->
														<p class="prodReview d-inline-block me-2">
															<i class="fa-regular fa-comment-dots"></i>
															<span th:text="${revCntMap[product.prodId] ?: 0}"></span>
														</p>

														<!--í•˜íŠ¸ìˆ˜-->
														<p class="prodFavorite d-inline-block">
															<i class="fa-regular fa-heart"></i>
															<span th:text="${product.favoriteProductList.size}"></span>
														</p>
													</div>

													<div class="prodTags">
														<!--í• ì¸ìœ¨ ìˆëŠ” ê²½ìš° ì„¸ì¼ìƒí’ˆ íƒœê·¸ í‘œì‹œ-->
														<span class="badge text-bg-success" th:text="ï¸ì„¸ì¼ìƒí’ˆ"
															th:if="${product.prodDiscount != null and product.prodDiscount > 0}"></span>
													</div>
												</a>
											</div> <!-- //card-body -->
										</div>
									</div>
								</div>
							</th:block>
						</th:block>
					</th:block>

					<!-- í˜ì´ì§€ë„¤ì´ì…˜ ë²„íŠ¼ -->
					<th:block th:if="${#lists.size(productList) > 4}">
						<div class="pagination">
							<button id="prevButton" class="" onclick="changePage(-1)"><</button>
							<button id="nextButton" class="" onclick="changePage(1)">></button>
						</div>
					</th:block>
				</div>
			</div>


			<!-- ì¡°ë¦¬ ìˆœì„œ -->
			<h2 class="mt-4">ì¡°ë¦¬ ìˆœì„œ</h2>
			<ol class="mb-4">
				<th:block th:each="orderCard, iterStat : ${recipe.cookOrderCardList}">
					<li class="step">
						<div class="card mb-3">
							<div class="row no-gutters">
								<div class="col-4">
									<img th:src="${orderCard.cookOrderImg}" alt="ì¡°ë¦¬ ì´ë¯¸ì§€" class="step-image"
										th:if="${orderCard.cookOrderImg != null}" style="object-fit: cover;" />
								</div>
								<div class="col-8">
									<div class="card-body">
										<span class="orderNum" th:text="${iterStat.index + 1}"></span> <!-- ìˆœì„œ í‘œì‹œ -->
										<span class="cookInstructions" th:text="${orderCard.cookOrderText}"></span>
										<!-- ì¡°ë¦¬ í…ìŠ¤íŠ¸ í‘œì‹œ -->
									</div>
								</div>
							</div>
						</div>
					</li>
				</th:block>
			</ol>
			<!-- ìˆ˜ì • ë° ì‚­ì œ ë²„íŠ¼ -->
			<div class="btn-group" th:if="${session.UserId == recipe.writer} or ${session.UserId == 'admin'}">
				<a th:href="@{/life/recipe/edit/{id}(id=${recipe.id})}" class="btn btn-primary">ìˆ˜ì •</a>
				<form th:action="@{/life/recipe/delete/{id}(id=${recipe.id})}" method="post" style="display:inline;">
					<button type="submit" class="btn btn-danger">ì‚­ì œ</button>
				</form>
			</div>
		</div>
		<script>
			let currentPage = 0;
			const itemsPerPage = 4; // í•œ í˜ì´ì§€ì— ë³´ì—¬ì¤„ ìƒí’ˆ ìˆ˜
			const productCards = document.querySelectorAll('.product-card');
			const totalCards = productCards.length;
			const totalPages = Math.ceil(totalCards - itemsPerPage + 1); // ë§ˆì§€ë§‰ í˜ì´ì§€ ê³„ì‚°

			function showPage(page) {
				// ì‹œì‘ ì¸ë±ìŠ¤ì™€ ë ì¸ë±ìŠ¤ë¥¼ ê³„ì‚°
				const startIndex = page;
				const endIndex = startIndex + itemsPerPage;

				productCards.forEach((card, index) => {
					// í˜„ì¬ í˜ì´ì§€ì— í•´ë‹¹í•˜ëŠ” ì¹´ë“œë§Œ ë³´ì´ë„ë¡ ì„¤ì •
					card.style.display = (index >= startIndex && index < endIndex) ? 'block' : 'none';
				});

				// ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™” ì„¤ì •
				    document.getElementById('prevButton').disabled = (page === 0);
				    document.getElementById('nextButton').disabled = (page === totalPages - 1);
			}

			function changePage(direction) {
				currentPage += direction;

				// í˜ì´ì§€ ë²”ìœ„ ì²´í¬
				if (currentPage < 0) currentPage = 0;
				if (currentPage > totalCards - itemsPerPage) currentPage = totalCards - itemsPerPage;

				showPage(currentPage);
			}

			// ì´ˆê¸° í˜ì´ì§€ ë¡œë“œ
			showPage(currentPage);


			$(document).ready(function () {
				var userId = $('#userId').val(); // ì‚¬ìš©ì IDë¥¼ í˜ì´ì§€ì—ì„œ ê°€ì ¸ì˜µë‹ˆë‹¤ (ì˜ˆ: hidden input)
				var recipeId = $('#recipeId').val(); // ë ˆì‹œí”¼ IDë¥¼ í˜ì´ì§€ì—ì„œ ê°€ì ¸ì˜µë‹ˆë‹¤ (ì˜ˆ: hidden input)
				// í˜ì´ì§€ ë¡œë“œ ì‹œ ì°œí•œ ìƒíƒœ í™•ì¸
				$.ajax({
					url: '/favorite/check',  // ì„œë²„ì˜ ìƒíƒœ í™•ì¸ URL
					type: 'GET',
					data: {
						userId: userId,
						recipeId: recipeId
					},
					success: function (response) {
						if (response.isFavorite) {
							$('.favorite-btn').addClass('bi-heart-fill').removeClass('bi-heart');
						} else {
							$('.favorite-btn').addClass('bi-heart').removeClass('bi-heart-fill');
						}
					},
					error: function (error) {
						console.error('ìƒíƒœ í™•ì¸ ì‹¤íŒ¨:', error);
					}
				});

				// ì°œ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
				$('.favorite-btn').click(function () {
					var isFavorite = $(this).hasClass('bi-heart-fill'); // í˜„ì¬ ì•„ì´ì½˜ ìƒíƒœ í™•ì¸

					if (isFavorite) {
						// ì°œ ì·¨ì†Œ ìš”ì²­
						$.ajax({
							url: '/favorite/remove',  // ì„œë²„ì˜ ì·¨ì†Œ URL
							type: 'POST',
							data: {
								userId: userId,
								recipeId: recipeId
							},
							success: function (response) {
								alert('ì°œí•œ ë ˆì‹œí”¼ì—ì„œ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤!');
								// ì•„ì´ì½˜ ìƒíƒœ ë³€ê²½
								$(this).removeClass('bi-heart-fill').addClass('bi-heart');
								location.reload();
							}.bind(this), // this ë°”ì¸ë”©
							error: function (error) {
								alert('ì·¨ì†Œí•˜ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
							}
						});
					} else {
						// ì°œ ì¶”ê°€ ìš”ì²­
						$.ajax({
							url: '/favorite/add',
							type: 'POST',
							data: {
								userId: userId,
								recipeId: recipeId
							},
							success: function (response) {
								if (response === "success") {
									alert('ì°œí•œ ë ˆì‹œí”¼ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!');
									// ì¶”ê°€ëœ ì•„ì´ì½˜ ìƒíƒœ ë³€ê²½ ë“±
									location.reload();

								} else if (response === "already_favorited") {
									alert('ì´ë¯¸ ì°œí•œ ë ˆì‹œí”¼ì…ë‹ˆë‹¤.');
								} else {
									alert('ì°œí•˜ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
								}

							},
							error: function (error) {
								alert('ì°œí•˜ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
							}
						});
					}
				});
			});
		</script>
	</div>

</body>

</html>