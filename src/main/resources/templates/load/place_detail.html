<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<html layout:decorate="~{layout}">

<head>
	<title>ìƒí’ˆ ìƒì„¸í˜ì´ì§€</title>

</head>
<div layout:fragment="content" class="container">
	<!--shop style link-->
	<link rel="stylesheet" th:href="@{/css/place_detail.css}">

	<!-- Bootstrap CSS -->
	<link href="https://stackpath.bootstrapcdn.com/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">

	<!-- Bootstrap JS (í•„ìš”í•œ ê²½ìš° Popper.js í¬í•¨) -->
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
	<link rel="stylesheet"
		href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css">
	<script
		src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>
	<!-- í•œê¸€ ì–¸ì–´ íŒŒì¼ ì¶”ê°€ -->
	<script
		src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/locales/bootstrap-datepicker.kr.min.js"></script>

	<!-- Tempus Dominus (ë‹¤ë¥¸ ë‚ ì§œ ì„ íƒê¸°) ê´€ë ¨ ë§í¬ëŠ” í•„ìš”ì— ë”°ë¼ ìœ ì§€ -->
	<link rel="stylesheet"
		href="https://cdnjs.cloudflare.com/ajax/libs/tempusdominus-bootstrap-4/5.39.0/css/tempusdominus-bootstrap-4.min.css" />
	<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
	<script
		src="https://cdnjs.cloudflare.com/ajax/libs/tempusdominus-bootstrap-4/5.39.0/js/tempusdominus-bootstrap-4.min.js"></script>




	<!-- ê°€ê²Œ ì •ë³´ ìš”ì•½ & ì£¼ë¬¸ í¼ -->
	<div class="container p-5 pt-0 my-5">
		<section class="placeInfo row p-5 rounded-2">
			<div class="placeImg col-5">
				<!-- ìƒí’ˆì´ë¯¸ì§€ -->
				<div class="card-img-wrapper rounded-2 mb-3">
					<div class="card-img-box" th:style="|background-image: url(@{  ${store.stoImage}  });|"></div>
				</div>
			</div> <!--placeImg-->
			<div class="col-7 card">
				<!-- ìƒí’ˆì •ë³´ -->
				<div class="card-body">
					<p class="card-text placeTitle d-flex justify-content-between align-items-center">
						<span th:text="${store.stoTitle}"></span>
						<span class="icons d-flex align-items-center">
							<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="#808080"
								class="bi bi-eye" viewBox="0 0 16 16">
								<path
									d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8M1.173 8a13 13 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5s3.879 1.168 5.168 2.457A13 13 0 0 1 14.828 8q-.086.13-.195.288c-.335.48-.83 1.12-1.465 1.755C11.879 11.332 10.119 12.5 8 12.5s-3.879-1.168-5.168-2.457A13 13 0 0 1 1.172 8z" />
								<path
									d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5M4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0" />
							</svg>
							<span th:text="${store.viewCount}"></span>

							<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
								class="bi bi-chat" viewBox="0 0 16 16">
								<path
									d="M2.678 11.894a1 1 0 0 1 .287.801 11 11 0 0 1-.398 2c1.395-.323 2.247-.697 2.634-.893a1 1 0 0 1 .71-.074A8 8 0 0 0 8 14c3.996 0 7-2.807 7-6s-3.004-6-7-6-7 2.808-7 6c0 1.468.617 2.83 1.678 3.894m-.493 3.905a22 22 0 0 1-.713.129c-.2.032-.352-.176-.273-.362a10 10 0 0 0 .244-.637l.003-.01c.248-.72.45-1.548.524-2.319C.743 11.37 0 9.76 0 8c0-3.866 3.582-7 8-7s8 3.134 8 7-3.582 7-8 7a9 9 0 0 1-2.347-.306c-.52.263-1.639.742-3.468 1.105" />
							</svg>
							<span th:text="${store.storeReviews.size}"></span>

							<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
								class="bi bi-heart" viewBox="0 0 16 16">
								<path
									d="m8 2.748-.717-.737C5.6.281 2.514.878 1.4 3.053c-.523 1.023-.641 2.5.314 4.385.92 1.815 2.834 3.989 6.286 6.357 3.452-2.368 5.365-4.542 6.286-6.357.955-1.886.838-3.362.314-4.385C13.486.878 10.4.28 8.717 2.01zM8 15C-7.333 4.868 3.279-3.04 7.824 1.143q.09.083.176.171a3 3 0 0 1 .176-.17C12.72-3.042 23.333 4.867 8 15" />
							</svg>
							<span th:text="${store.favoriteStores.size}"></span>
						</span>
					</p>
					<h3 class="placeName card-title" th:text="${store.stoName}"></h3>
					<p class="placeDesc card-text" th:text="${store.stoContent}"></p>
					<table class="table">
						<tbody>

							<tr>
								<td><strong>ì¹´í…Œê³ ë¦¬</strong></td>
								<td><span th:text="${store.stoCategory}"></span></td>
							</tr>

							<tr>
								<td><strong>ì—°ë½ì²˜</strong></td>
								<td><span th:text="${store.stoContact}"></span></td>
							</tr>
							<tr>
								<td><strong>ì£¼ì†Œ</strong></td>
								<td><span th:text="${store.stoAddress}"></span></td>
							</tr>
							<tr>
								<td><strong>ìš´ì˜ ì‹œê°„</strong></td>
								<td><span th:text="${store.stoOperatingHours}"></span></td>
							</tr>
							<tr>
								<td><strong>íœ´ë¬´ì¼</strong></td>
								<td><span th:text="${store.stoClosedDays}"></span></td>
							</tr>
							<tr>
								<td><strong>í‰ì </strong></td>
								<td><span th:text="${store.recommendationCount}"></span></td>
							</tr>
							<tr>
								<td><strong>ì¶”ì²œ ë©”ë‰´</strong></td>
								<td><span th:text="${store.stoRecommendedMenu}"></span></td>
							</tr>
							<tr>
								<td><strong>ì£¼ì°¨ ì •ë³´</strong></td>
								<td><span th:text="${store.stoParkingInfo}"></span></td>
							</tr>
							<tr>
								<td><strong>ì±„ì‹ì¢…ë¥˜</strong></td>
								<td><span th:text="${store.stoVegetarianType}"></span></td>
							</tr>
							<tr>
								<td><strong>ì˜ì—… ì—¬ë¶€</strong></td>
								<td><span th:text="${store.isOpen} ? 'ì˜ì—… ì¤‘' : 'ì˜ì—… ì¢…ë£Œ'"></span></td>
							</tr>
						</tbody>
					</table>

					<span class="favorite-btn btn hm-btn-green w-25" th:data-userid="${session.UserId}"
						th:data-storeid="${store.stoId}">ì°œğŸ‘</span>
					<span class='btn hm-btn-green reservation-btn w-25' th:data-userid="${session.UserId}"
						th:data-storeid="${store.stoId}" th:data-openhours="${store.stoOperatingHours}">ì˜ˆì•½ğŸ—“ï¸</span>
					<div th:id="'reservationForm_' + ${store.stoId}" class="reservationBox p-3" style="display: none;">
						<h5>ì˜ˆì•½ ì‹œê°„ ì„ íƒ</h5>
						<div class="form-group">
							<label th:for="'reservationDate_' + ${store.stoId}">ì˜ˆì•½ ë‚ ì§œ ì„ íƒ:</label>
							<div class="input-group">
								<input type="text" class="form-control" th:id="'reservationDate_' + ${store.stoId}"
									placeholder="YYYY-MM-DD" required>
								<div class="input-group-append">
									<span class="input-group-text">
										<i class="fa fa-calendar" aria-hidden="true"></i>
									</span>
								</div>
							</div>
						</div>

						<div class="form-group my-2">
							<label th:for="'reservationTime_' + ${store.stoId}">ì˜ˆì•½ ì‹œê°„ ì„ íƒ:</label>
							<select th:id="'reservationTime_' + ${store.stoId}" class="form-control">
								<!-- ì—¬ê¸°ì„œ JavaScriptë¡œ ë™ì ìœ¼ë¡œ ì˜µì…˜ ì¶”ê°€ -->
							</select>
						</div>

						<button class="btn btn-primary" onclick="makeReservation()">í™•ì¸</button>
						<button class="btn btn-secondary" onclick="hideReservationForm()">ì·¨ì†Œ</button>
					</div>
				</div> <!-- //card-body -->
			</div> <!--col-6 card-->
		</section> <!--placeInfo-->

	</div>
	<!-- ìƒì ë³„ ë¦¬ë·° -->
	<section class="storeReview my-5 p-3">
		<h3 class="my-3 fw-bold">ìƒì  í›„ê¸°</h3>

		<!-- ì´ë¯¸ì§€ ë³´ê¸° -->
		<div th:if="${filteredReviewsCount <= 8}">
			<div class="revImgWrapper" th:if="${filteredReviewsCount != 0}">
				<div class="revImgContainer ">
					<div class="carousel-inner justify-content-start">
						<th:block th:each="review, iterStat : ${filteredReviews}">
							<div class="carousel-item "
								th:class="'carousel-item ' + (${iterStat.index < 8} ? 'active' : '')">
								<a href="#" class="revImgLink d-block">
									<div class="revImgBox" th:style="'background-image: url(' + ${review.revImg} + ');'"
										th:data-img-url="${review.revImg}" th:data-sto-name="${store.stoName}"
										th:data-rev-text="${review.revText}" th:data-rev-rating="${review.revRating}"
										th:data-created-at="${#temporals.format(review.createdAt, 'yyyy.MM.dd')}"
										onclick="openModal(this)"></div>
								</a>
							</div>
						</th:block>
					</div> <!-- carousel-inner -->
				</div> <!-- revImgContainer -->
			</div> <!-- revImgWrapper -->
		</div>
		<div id="reviewCarousel" class="carousel slide" th:if="${filteredReviewsCount > 8}">
			<div class="revImgWrapper">
				<div class="revImgContainer">
					<div class="carousel-inner">
						<th:block th:each="review, iterStat : ${filteredReviews}">
							<div class="carousel-item "
								th:class="'carousel-item ' + (${iterStat.index < 8} ? 'active' : '')">
								<span class="revImgLink d-block">
									<div class="revImgBox" th:style="'background-image: url(' + ${review.revImg} + ');'"
										th:data-img-url="${review.revImg}" th:data-sto-name="${store.stoName}"
										th:data-rev-text="${review.revText}" th:data-rev-rating="${review.revRating}"
										th:data-created-at="${#temporals.format(review.createdAt, 'yyyy.MM.dd')}"
										onclick="openModal(this)"></div>
								</span>
							</div>
						</th:block>
					</div> <!-- carousel-inner -->
					<a class="carousel-control-prev">
						<span class="carousel-control-prev-icon" aria-hidden="true"></span>
						<span class="visually-hidden">ì´ì „</span>
					</a>
					<a class="carousel-control-next">
						<span class="carousel-control-next-icon" aria-hidden="true"></span>
						<span class="visually-hidden">ë‹¤ìŒ</span>
					</a>
				</div> <!-- revImgContainer -->
			</div> <!-- revImgWrapper -->
		</div> <!-- reviewCarousel -->

		<!-- ë¦¬ë·° ë³´ê¸° ë¸”ë¡ -->
		<div id="reviews my-3">
			<div class="row border-bottom my-2">
				<span class="my-2">ì´
					<span th:text="${store.storeReviews.size()}"></span>
					ê°œ
				</span>

			</div>
			<div th:if="${store.storeReviews.size() == 0}" class="no-reviews-box text-center p-4 border rounded">
				<h5 class="mb-3">ì•„ì§ í›„ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤!</h5>
				    <p>ì²« ë²ˆì§¸ í›„ê¸°ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”.</p>
				    <svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" fill="#808080" class="bi bi-chat" viewBox="0 0 16 16">
				        <path d="M2.678 11.894a1 1 0 0 1 .287.801 11 11 0 0 1-.398 2c1.395-.323 2.247-.697 2.634-.893a1 1 0 0 1 .71-.074A8 8 0 0 0 8 14c3.996 0 7-2.807 7-6s-3.004-6-7-6-7 2.808-7 6c0 1.468.617 2.83 1.678 3.894m-.493 3.905a22 22 0 0 1-.713.129c-.2.032-.352-.176-.273-.362a10 10 0 0 0 .244-.637l.003-.01c.248-.72.45-1.548.524-2.319C.743 11.37 0 9.76 0 8c0-3.866 3.582-7 8-7s8 3.134 8 7-3.582 7-8 7a9 9 0 0 1-2.347-.306c-.52.263-1.639.742-3.468 1.105" />
				    </svg>
			</div>
			<div class="row border-bottom reviewBlock py-2 my-3"
				th:each="review : ${store.storeReviews}">

				<div class="col-md-2 writer">[[${review.writer}]]</div>
				<div class="col-md-10">
					<div class="row revText justify-content-start mb-3 revStoName">
						<div class="col">[[${store.stoName}]]</div>
					</div>

					<div class="row revText justify-content-start my-3">
						<div class="col">[[${review.revText}]]</div>
					</div>
					<div class="row revImgRow justify-content-start">
						<div class="col">
							<div class="revImgBox" th:if="${review.revImg != null}"
								th:style="'background-image: url(' + ${review.revImg} + ');'"
								th:data-img-url="${review.revImg}" th:data-sto-name="${store.stoName}"
								th:data-rev-text="${review.revText}" th:data-rev-rating="${review.revRating}"
								th:data-created-at="${#temporals.format(review.createdAt, 'yyyy.MM.dd')}"
								onclick="openModal(this)">
							</div>
							<div class="col" id="ratingContainer" th:if="${review.revRating == 1}">ë³„ì : â˜…â˜†â˜†â˜†â˜†</div>
							<div class="col" id="ratingContainer" th:if="${review.revRating == 2}">ë³„ì : â˜…â˜…â˜†â˜†â˜†</div>
							<div class="col" id="ratingContainer" th:if="${review.revRating == 3}">ë³„ì : â˜…â˜…â˜…â˜†â˜†</div>
							<div class="col" id="ratingContainer" th:if="${review.revRating == 4}">ë³„ì : â˜…â˜…â˜…â˜…â˜†</div>
							<div class="col" id="ratingContainer" th:if="${review.revRating == 5}">ë³„ì : â˜…â˜…â˜…â˜…â˜…</div>
						</div>
					</div>
					<div class="row createdAt justify-content-start my-3">
						<div class="col">
							<small th:text="${#temporals.format(review.createdAt, 'yyyy.MM.dd.hh.mm.ss')}"></small>
						</div>
					</div>
					<button th:if="${review.writer == session.UserId}" class="delete-review btn btn-danger" th:data-rev-id="${review.revId}">ì‚­ì œ</button>
				</div>
			</div>
			<button id="loadMoreButton" class="btn btn-primary my-3" style="display: none;">ë¦¬ë·° ë”ë³´ê¸°</button>
		</div>
		
		<div class="btn hm-btn-border-green reviewFormBtn my-2 w-25">
			í›„ê¸° ì‘ì„±í•˜ê¸°
		</div>
		<!-- ëª¨ë‹¬ êµ¬ì¡° -->
		<div id="imageModal" class="modal" tabindex="-1" role="dialog">
			<div class="modal-dialog" role="document">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title">ì‚¬ì§„ í›„ê¸°</h5>
					</div>
					<div class="modal-body">
						<div class="row">
							<div class="col-7 ">
								<img id="modalImage" src="" alt="ë¦¬ë·° ì´ë¯¸ì§€" class="img-fluid">
							</div>
							<div class="col-5">
								<p>ê°€ê²Œëª… : <span id="modalStoName"></span></p>
								<p>ë‚´ìš© : <span id="modalRevText"></span></p>
								<p id="modalRevRating"></p>
								<p>ì‘ì„±ì¼ : <small id="modalCreatedAt"></small></p>
							</div>
						</div>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary" onclick="closeModal()">ë‹«ê¸°</button>
					</div>
				</div>
			</div>
		</div>
		<!-- ë¦¬ë·° ì¶”ê°€ í¼ -->
		<form id="reviewForm" enctype="multipart/form-data" class="p-4 my-2 no-reviews-box" >
			<h3 class="my-3">í›„ê¸° ì‘ì„±</h3>
			<h5>ì¥ì†Œ ë§Œì¡±ë„</h5>
			<div id="starRating">
				<span class="star" data-value="1">â˜…</span>
				<span class="star" data-value="2">â˜…</span>
				<span class="star" data-value="3">â˜…</span>
				<span class="star" data-value="4">â˜…</span>
				<span class="star" data-value="5">â˜…</span>
			</div>
			<h5 class="my-2">ì¥ì†Œ í›„ê¸°</h5>
			<textarea id="revText" placeholder="ìƒì  í›„ê¸°ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”" required class="my-2 p-4 row"></textarea>
			<input type="hidden" id="revRating" required />
			<div class="row my-4">
				<h5>ì‚¬ì§„ ì˜¬ë¦¬ê¸°</h5>
				<input type="file" id="revImg" accept="image/*" />
			</div>
			<button type="submit" class="btn hm-btn-green">ë¦¬ë·° ì¶”ê°€</button>
		</form>


	</section>
	<button class="btn btn-danger" th:if="${session.UserId == 'admin'}" th:id="'delete-' + ${store.stoId}"
		th:onclick="'deleteStore(' + ${store.stoId} + ')'" >ê°€ê²Œ ì‚­ì œ</button>
	<a th:if="${session.UserId == 'admin'}" th:href="@{/load/store/update(id=${store.stoId})}" class="btn btn-info"
		id="updateButton">ê°€ê²Œ ìˆ˜ì •</a>
	<script>
		function deleteStore(stoId) {
			// ì‚­ì œ í™•ì¸ ëŒ€í™” ìƒì
			const isConfirmed = confirm("ì •ë§ë¡œ ì´ ê°€ê²Œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")

			if (isConfirmed) {
				fetch(`/load/store/delete/${stoId}`, {
					method: 'DELETE'
				})
					.then(response => {
						if (response.ok) {
							alert("ê°€ê²Œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
							window.location.href = 'http://localhost:8080/load/place'; // í˜ì´ì§€ ë¦¬ë‹¤ì´ë ‰íŠ¸
						} else {
							alert("ê°€ê²Œ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
						}
					});
			} else {
				alert("ê°€ê²Œ ì‚­ì œê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.");
			}
		}

		function openModal(element) {
			const imgUrl = element.getAttribute('data-img-url');
			const stoName = element.getAttribute('data-sto-name');
			const revText = element.getAttribute('data-rev-text');
			const revRating = element.getAttribute('data-rev-rating');
			const createdAt = element.getAttribute('data-created-at');

			// ëª¨ë‹¬ì— ì •ë³´ ì„¤ì •
			document.getElementById('modalImage').src = imgUrl; // ì´ë¯¸ì§€ URL ì„¤ì •
			document.getElementById('modalStoName').innerText = stoName; // ìƒí˜¸ëª… ì„¤ì •
			document.getElementById('modalRevText').innerText = revText; // ë¦¬ë·° í…ìŠ¤íŠ¸ ì„¤ì •
			document.getElementById('modalRevRating').innerText = `ë³„ì : ${'â˜…'.repeat(revRating)}${'â˜†'.repeat(5 - revRating)}`; // ë³„ì  ì„¤ì •
			document.getElementById('modalCreatedAt').innerText = createdAt; // ìƒì„± ë‚ ì§œ ì„¤ì •

			$('#imageModal').modal('show'); // Bootstrap ëª¨ë‹¬ ì—´ê¸°
		}

		function closeModal() {
			$('#imageModal').modal('hide'); // Bootstrap ëª¨ë‹¬ ë‹«ê¸°
		}

		document.addEventListener('DOMContentLoaded', function () {
			const stars = document.querySelectorAll('.star');
			const revRatingInput = document.getElementById('revRating');
			stars.forEach(star => {
				star.addEventListener('click', function () {
					const rating = this.getAttribute('data-value');
					revRatingInput.value = rating; // í‰ì  ê°’ì„ ìˆ¨ê²¨ì§„ ì…ë ¥ í•„ë“œì— ì €ì¥
					updateStarDisplay(rating); // ë³„ì  í‘œì‹œ ì—…ë°ì´íŠ¸
				});
			});

			function updateStarDisplay(rating) {
				stars.forEach(star => {
					if (star.getAttribute('data-value') <= rating) {
						star.classList.add('selected'); // ì„ íƒëœ ë³„ì ì— ìŠ¤íƒ€ì¼ ì¶”ê°€
					} else {
						star.classList.remove('selected');
					}
				});
			}

			document.getElementById('reviewForm').addEventListener('submit', function (event) {
				event.preventDefault(); // ê¸°ë³¸ í¼ ì œì¶œ ë°©ì§€

				const formData = new FormData();
				formData.append('revText', document.getElementById('revText').value);
				formData.append('revRating', revRatingInput.value); // í‰ì  ì¶”ê°€

				// íŒŒì¼ì´ ì„ íƒë˜ì§€ ì•Šì•˜ë”ë¼ë„ ë¦¬ë·°ë¥¼ ì¶”ê°€í•  ìˆ˜ ìˆë„ë¡ ìˆ˜ì •
				const revImg = document.getElementById('revImg').files[0];
				if (revImg) {
					formData.append('revImg', revImg); // íŒŒì¼ ì¶”ê°€
				}

				const pathParts = window.location.pathname.split('/'); // ê²½ë¡œë¥¼ '/'ë¡œ ë‚˜ëˆ„ê¸°
				const placeId = pathParts[pathParts.length - 1]; // ë§ˆì§€ë§‰ ë¶€ë¶„ì´ placeId

				// ë¦¬ë·° ì¶”ê°€ API í˜¸ì¶œ
				fetch(`http://localhost:8080/load/place/${placeId}/reviews`, {
					method: 'POST',
					body: formData
				})
					.then(response => {
						if (response.ok) {
							return response.json(); // JSON ì‘ë‹µì„ ë°˜í™˜
						} else if (response.status === 401) {
							alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
							window.location.href = 'http://localhost:8080/member/login'; // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
							return Promise.reject(); // ë¦¬ë‹¤ì´ë ‰íŠ¸ í›„ í•¨ìˆ˜ ì¢…ë£Œ
						} else if (response.status === 400) {
							alert('ë¦¬ë·° í…ìŠ¤íŠ¸ê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.'); // ì˜ëª»ëœ ìš”ì²­ ì²˜ë¦¬
							return;
						} else {
							throw new Error('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ìƒíƒœ ì½”ë“œ: ' + response.status);
						}
					})
					.then(data => {
						// ì„±ê³µì ìœ¼ë¡œ ë¦¬ë·°ê°€ ì¶”ê°€ë˜ë©´ UI ì—…ë°ì´íŠ¸
						alert('ë¦¬ë·°ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!');
						document.getElementById('reviewForm').reset(); // í¼ ì´ˆê¸°í™”
						location.reload(); // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
					})
					.catch(error => {
						console.error('Error:', error);
						alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
					});
			});

			const reviewBlocks = document.querySelectorAll('.reviewBlock'); // ëª¨ë“  ë¦¬ë·° ë¸”ë¡ ì„ íƒ
			const loadMoreButton = document.getElementById('loadMoreButton'); // "ë”ë³´ê¸°" ë²„íŠ¼ ì„ íƒ

			let currentIndex = 0; // í˜„ì¬ ë³´ì—¬ì£¼ëŠ” ë¦¬ë·° ì¸ë±ìŠ¤

			// ì´ˆê¸° 5ê°œ ë¦¬ë·°ë§Œ ë³´ì—¬ì£¼ëŠ” í•¨ìˆ˜
			function showInitialReviews() {
				const totalReviews = reviewBlocks.length; // ì´ ë¦¬ë·° ìˆ˜
				for (let i = 0; i < totalReviews; i++) {
					if (i < 5) {
						reviewBlocks[i].style.display = 'flex'; // ì²˜ìŒ 5ê°œ ë¦¬ë·° ë³´ì´ê¸°
					} else {
						reviewBlocks[i].style.display = 'none'; // ë‚˜ë¨¸ì§€ ë¦¬ë·° ìˆ¨ê¸°ê¸°
					}
				}
				currentIndex = 5; // í˜„ì¬ ì¸ë±ìŠ¤ ì—…ë°ì´íŠ¸
				loadMoreButton.style.display = currentIndex < totalReviews ? 'block' : 'none'; // "ë”ë³´ê¸°" ë²„íŠ¼ í‘œì‹œ
			}

			// "ë”ë³´ê¸°" ë²„íŠ¼ í´ë¦­ ì‹œ í˜¸ì¶œë˜ëŠ” í•¨ìˆ˜
			loadMoreButton.addEventListener('click', function () {
				const totalReviews = reviewBlocks.length; // ì´ ë¦¬ë·° ìˆ˜
				for (let i = currentIndex; i < currentIndex + 5 && i < totalReviews; i++) {
					reviewBlocks[i].style.display = 'flex'; // ë‹¤ìŒ 5ê°œ ë¦¬ë·° ë³´ì´ê¸°
				}
				currentIndex += 5; // í˜„ì¬ ì¸ë±ìŠ¤ ì—…ë°ì´íŠ¸
				loadMoreButton.style.display = currentIndex < totalReviews ? 'block' : 'none'; // "ë”ë³´ê¸°" ë²„íŠ¼ í‘œì‹œ
			});

			showInitialReviews(); // ì´ˆê¸° ë¦¬ë·° í‘œì‹œ
		});

		// ë¦¬ë·° ì‚­ì œ ê¸°ëŠ¥
		document.querySelectorAll('.delete-review').forEach(button => {
			button.addEventListener('click', function () {
				const revId = this.getAttribute('data-rev-id'); // ë¦¬ë·° ID ê°€ì ¸ì˜¤ê¸°
				const confirmed = confirm('ì •ë§ë¡œ ì´ ë¦¬ë·°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?'); // ì‚­ì œ í™•ì¸
				const pathParts = window.location.pathname.split('/'); // ê²½ë¡œë¥¼ '/'ë¡œ ë‚˜ëˆ„ê¸°
				const placeId = pathParts[pathParts.length - 1]; // ë§ˆì§€ë§‰ ë¶€ë¶„ì´ placeId
				if (confirmed) {
					// ë¦¬ë·° ì‚­ì œ API í˜¸ì¶œ
					fetch(`http://localhost:8080/load/place/${placeId}/reviews/${revId}`, {
						method: 'DELETE'
					})
						.then(response => {
							if (response.ok) {
								alert('ë¦¬ë·°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤!');
								location.reload(); // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
							} else {
								throw new Error('ë¦¬ë·° ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
							}
						})
						.catch(error => {
							console.error('Error:', error);
							alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
						});
				}
			});
		});
		window.onload = function () {
			const pathParts = window.location.pathname.split('/'); // ê²½ë¡œë¥¼ '/'ë¡œ ë‚˜ëˆ„ê¸°
			const placeId = pathParts[pathParts.length - 1]; // ë§ˆì§€ë§‰ ë¶€ë¶„ì´ placeId
			// ë¦¬ë·° ì¶”ê°€ API í˜¸ì¶œ
			fetch(`http://localhost:8080/load/place/${placeId}/reviews`)
				.then(response => response.json())
				.then(data => {
					data.forEach(review => addReviewToUI(review));
				})
				.catch(error => console.error('Error fetching reviews:', error));
		};
		$(document).ready(function () {
			const reviewFormBtn = $(".reviewFormBtn")
			
			reviewFormBtn.click(function(){
				$("#reviewForm").slideToggle(); // ìŠ¬ë¼ì´ë“œ íš¨ê³¼ ì¶”ê°€
			})
			const carouselItems = $('#reviewCarousel .carousel-item');
			const totalItems = carouselItems.length;
			let nextcurrentIndex = 7;
			let prevcurrentIndex = 0;

			// ë‹¤ìŒ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
			$('.carousel-control-next').click(function () {
				if (nextcurrentIndex < totalItems - 1) {
					// í˜„ì¬ ì•„ì´í…œì—ì„œ active í´ë˜ìŠ¤ ì œê±°
					carouselItems.eq(prevcurrentIndex).removeClass('active');
					prevcurrentIndex++;
					// ì¸ë±ìŠ¤ ì¦ê°€
					nextcurrentIndex++;
					// ë‹¤ìŒ ì•„ì´í…œì— active í´ë˜ìŠ¤ ì¶”ê°€
					carouselItems.eq(nextcurrentIndex).addClass('active');
				} else {
					alert("ë‹¤ìŒ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.")
				}
			});

			// ì´ì „ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
			$('.carousel-control-prev').click(function () {
				if (prevcurrentIndex > 0) {
					// í˜„ì¬ ì•„ì´í…œì—ì„œ active í´ë˜ìŠ¤ ì œê±°
					carouselItems.eq(nextcurrentIndex).removeClass('active');
					nextcurrentIndex--;
					// ì¸ë±ìŠ¤ ê°ì†Œ
					prevcurrentIndex--;
					// ì´ì „ ì•„ì´í…œì— active í´ë˜ìŠ¤ ì¶”ê°€
					carouselItems.eq(prevcurrentIndex).addClass('active');
				} else {
					alert("ì´ì „ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.")
				}
			});

			const favoriteButtons = document.querySelectorAll('.favorite-btn');

			favoriteButtons.forEach(button => {
				button.addEventListener('click', function () {
					const userId = this.getAttribute('data-userid');
					const storeId = this.getAttribute('data-storeid');
					addFavorite(userId, storeId);
				});
			});

			const reservationButtons = document.querySelectorAll('.reservation-btn');

			reservationButtons.forEach(button => {
				button.addEventListener('click', function () {
					const userId = this.getAttribute('data-userid');
					const storeId = this.getAttribute('data-storeid');
					const openhours = this.getAttribute('data-openhours');
					showReservationForm(userId, storeId, openhours)
				})
			})
		});

		function addFavorite(memberId, stoId) {
			console.log('memberId:', memberId); // ë””ë²„ê¹…ìš© ì¶œë ¥
			console.log('stoId:', stoId); // ë””ë²„ê¹…ìš© ì¶œë ¥
			fetch(`/store/favorite/add?memberId=${memberId}&stoId=${stoId}`, { // ì„œë²„ì˜ API ì—”ë“œí¬ì¸íŠ¸
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
				},
				body: JSON.stringify({memberId: memberId, stoId: stoId})
			})
				.then(response => {
					if (response.ok) {
						alert('ì°œí•˜ê¸°ì— ì„±ê³µí–ˆìŠµë‹ˆë‹¤!');
					} else {
						return response.text().then(text => {
							alert(text); // ì„œë²„ì—ì„œ ì „ì†¡í•œ ì˜ˆì™¸ ë©”ì‹œì§€ë¥¼ ì‚¬ìš©ìì—ê²Œ í‘œì‹œ
						});
					}
				})
				.catch(error => {
					console.error('Error:', error);
					alert('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
				});
		}

		//ì˜ˆì•½ ì‹œê°„ í•¨ìˆ˜
		function populateReservationTimes(operatingHours) {
			const timeSelect = document.getElementById(`reservationTime_${window.currentStoId}`);
			timeSelect.innerHTML = ''; // ê¸°ì¡´ ì˜µì…˜ ì‚­ì œ

			const [start, end] = operatingHours.split(' - '); // ì‹œì‘ ì‹œê°„ê³¼ ì¢…ë£Œ ì‹œê°„ ë¶„ë¦¬
			const [startHour, startMinute] = start.split(':').map(Number);
			const [endHour, endMinute] = end.split(':').map(Number);
			const interval = 30; // ê°„ê²© (ë¶„ ë‹¨ìœ„)

			const now = new Date(); // í˜„ì¬ ì‹œê°„
			const currentHour = now.getHours();
			const currentMinute = now.getMinutes();

			// ì¢…ë£Œ ì‹œê°„ì—ì„œ 30ë¶„ ì „ ê³„ì‚°
			let adjustedEndHour = endHour;
			let adjustedEndMinute = endMinute - 30;

			if (adjustedEndMinute < 0) {
				adjustedEndHour -= 1;
				adjustedEndMinute += 60; // 60ë¶„ìœ¼ë¡œ ë³´ì •
			}

			// ì¢…ë£Œ ì‹œê°„ì´ 0ì‹œê°€ ë˜ì§€ ì•Šë„ë¡ ì²˜ë¦¬
			if (adjustedEndHour < startHour) {
				adjustedEndHour = startHour;
				adjustedEndMinute = 0;
			}

			for (let hour = startHour; hour <= adjustedEndHour; hour++) {
				for (let minute = (hour === startHour ? startMinute : 0); minute < 60; minute += interval) {
					if (hour === adjustedEndHour && minute > adjustedEndMinute) break; // ì¡°ì •ëœ ì¢…ë£Œ ì‹œê°„ ì´ˆê³¼ ì‹œ ì¤‘ë‹¨

					// í˜„ì¬ ì‹œê°„ë³´ë‹¤ ì´ì „ì˜ ì˜µì…˜ ì œê±°
					if (hour < currentHour || (hour === currentHour && minute <= currentMinute)) {
						continue; // ì´ì „ ì‹œê°„ì€ ê±´ë„ˆëœ€
					}

					const formattedHour = hour.toString().padStart(2, '0');
					const formattedMinute = minute.toString().padStart(2, '0');
					const optionValue = `${formattedHour}:${formattedMinute}`;
					const option = document.createElement('option');
					option.value = optionValue;
					option.textContent = optionValue;
					timeSelect.appendChild(option);
				}
			}
		}


		// ì˜ˆì•½ í¼ì´ ì—´ë¦´ ë•Œ ì‹œê°„ ì˜µì…˜ì„ ì±„ìš°ë„ë¡ ë³€ê²½
		function showReservationForm(userId, stoId, operatingHours) {
			document.getElementById(`reservationForm_${stoId}`).style.display = 'block';
			window.currentUserId = userId;
			window.currentStoId = stoId;
			populateReservationTimes(operatingHours); // ì‹œê°„ ì˜µì…˜ ì±„ìš°ê¸°


			// Bootstrap Datepicker ì´ˆê¸°í™” (í•œê¸€ ì„¤ì •)
			$(`#reservationDate_${stoId}`).datepicker({ // ìˆ˜ì •
				format: 'yyyy-mm-dd',
				autoclose: true,
				todayHighlight: true,
				language: "kr",
				startDate: new Date() // ì˜¤ëŠ˜ ë‚ ì§œë¶€í„° ì„ íƒ ê°€ëŠ¥
			}).datepicker('setDate', new Date()); // ì˜¤ëŠ˜ ë‚ ì§œë¡œ ì´ˆê¸°í™”


		}


		function makeReservation() {
			const reservationDate = $(`#reservationDate_${window.currentStoId}`).val();
			const reservationTime = $(`#reservationTime_${window.currentStoId}`).val();
			const userId = window.currentUserId;

			if (userId == 'ë¡œê·¸ì¸ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.') {
				alert(userId)
				return; // ë¡œê·¸ì¸ë˜ì§€ ì•Šì€ ê²½ìš° ì˜ˆì•½ì„ ì¤‘ë‹¨
			}

			const stoId = window.currentStoId; // ì´ ê°’ì´ Longìœ¼ë¡œ ë³€í™˜ë  ìˆ˜ ìˆë„ë¡ ì„¤ì •

			const reservationData = {
				userId: userId,
				stoId: stoId,
				reservationTime: `${reservationDate} ${reservationTime}`,
			};

			fetch('/store/reservations', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
				},
				body: JSON.stringify(reservationData),
			})
				.then(response => {
					if (!response.ok) {
						return response.json().then(err => {
							throw new Error(err.message || 'ì˜ˆì•½ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
						});
					}
					return response.json();
				})
				.then(data => {
					alert('ì˜ˆì•½ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
					hideReservationForm();  // ì˜ˆì•½ ì™„ë£Œ í›„ í¼ ìˆ¨ê¸°ê¸°
				})
				.catch(error => {
					alert(error.message);
				});
		}

		function hideReservationForm() {
			document.getElementById(`reservationForm_${window.currentStoId}`).style.display = 'none'; // ìˆ˜ì •
		}


	</script>
</div> <!--//layout::content-->

<!-- <script layout:fragment="script"> -->

</html>